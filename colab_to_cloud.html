
<html>
<head>

<title>Connecting Google Colaboratory to a runtime on a Google Compute Engine instance</title>
<meta name="description" content="Connecting Google Colaboratory to a runtime on a Google Compute Engine instance">

<style>
pre, code {background-color: lightgray;}
</style>
</head>
<body>

<h1>Connecting Google Colaboratory to a runtime on a Google Compute Engine instance
</h1>

<p>筆者最開始學習Deep Learning時是用免費的Google Colab，後來一些專案需要比較大的記憶體，所以在Google Cloud Platform的Compute Engine租用主機。但Google Colab只提供連線到本機電腦，所以要讓Google Colab可以連線到這個架設在Compute Engine上的主機就需要一些設定。連線關係如下圖。
</p>

<br><img width="70%" src="img/colab_to_cloud/preface.jpg">

<p>其實Google Cloud自己本身也有提供Notebooks（在Google Cloud Platform, AI Platform (Unified)下面），但頗難用，未來或許Google就會把Google Colab取代掉這個，並且Google Colab可以直接連線也說不定。
</p>

<p>主要的方法是參考<a href="https://research.google.com/colaboratory/local-runtimes.html">這份官方說明</a>，不過有些細節講得不是很清楚，所以才有了這篇文章的誕生。
</p>
  
<p><font color="red">要注意的是，連線到主機後，有很多原本在Google Colab的指令可能就不能直接使用，要另外安裝，下面舉幾個例子。</font>
</p>
  
<table border="1">
<tbody>
<tr>
<th>解法</th>
<th>錯誤訊息</th>
<th>功能</th>
</tr>
<tr>
<td>pip install -q gdown</td>
<td>&nbsp;</td>
<td>安裝後可以下載Google Drive檔案，例如!gdown --id abc123<br />id可以從網址https://drive.google.com/file/d/abc123/view找到，<br />-q表示不要顯示細節，<br />如果出現訊息Note: you may need to restart the kernel to use updated packages.但不方便重新啟動的話也可以不用。</td>
</tr>
<tr>
<td>pip install -q keras</td>
<td>ModuleNotFoundError: No module named 'keras'</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>pip install -q sklearn</td>
<td>ModuleNotFoundError: No module named 'sklearn'</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>pip install -q matplotlib</td>
<td>ModuleNotFoundError: No module named 'matplotlib'</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>pip install scikit-image</td>
<td>ModuleNotFoundError: No module named 'skimage'</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>!sudo apt install unzip</td>
<td>&nbsp;</td>
<td>安裝之後可以解壓縮檔案，例如!unzip -qq abc123.zip</td>
</tr>
<tr>
<td>!sudo apt install libgl1-mesa-glx -y</td>
<td>ImportError: libGL.so.1: cannot open shared object file: No such file or directory</td>
<td>如果不加-y的話，安裝時會詢問同不同意。</td>
</tr>
<tr>
<td>pip install tensorflow</td>
<td>ModuleNotFoundError: No module named 'tensorflow'</td>
<td>如果出現MemoryError的錯誤訊息的話，就要改用指令pip install --no-cache-dir tensorflow</td>
</tr>
<tr>
<td>pip install opencv-python</td>
<td>ModuleNotFoundError: No module named 'cv2'</td>
<td>如果出現MemoryError的錯誤訊息的話，就要改用指令pip install --no-cache-dir opencv-python</td>
</tr>
<tr>
<td>command</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>










<!---------------------------------->
<!---------------------------------->

<h2>Part A</h2>

<ol>

<li>
先前往<a href="https://cloud.google.com/">Google Cloud</a>。如果介面是中文的話建議切換成英文，遇到問題的時候比較方便把錯誤訊息輸入google，搜尋解法。
<br><img width="70%" src="img/colab_to_cloud/VM1.jpg">
</li>

<li>
接著前往<a href="https://cloud.google.com/">Console</a>。第一次使用的話需要註冊信用卡，第一年有300 USD的試用額度。
<br><img width="70%" src="img/colab_to_cloud/VM2.jpg">
</li>

<li>
首先要建立專案，在左上角會顯示專案名稱，點一下可以顯示目前有的專案清單。
<br><img width="70%" src="img/colab_to_cloud/VM3.jpg">
</li>

<li>
顯示專案清單，如果要新增專案的話就按下右上角的[NEW PROJECT]。
<br><img width="70%" src="img/colab_to_cloud/VM4.jpg">
</li>

<li>
新增新的專案，輸入完專案名稱後按下[CREATE]建立。
<br><img width="70%" src="img/colab_to_cloud/VM5.jpg">
</li>

<li>
新增完後一樣點選左上角的專案名稱。
<br><img width="70%" src="img/colab_to_cloud/VM6.jpg">
</li>

<li>
可以看到新增的專案出現在清單上了，<font color="red">注意看一下後面的ID，通常會跟專案名稱差不多，但會是小寫字母，而且會用-(hyphen)取代空格，這個ID是專案在電腦中用來識別的正式名稱，我們剛剛取的專案名稱是比較適合我們人類看懂的。</font>點選該專案就可以切換成該專案。
<br><img width="70%" src="img/colab_to_cloud/VM7.jpg">
</li>

<li>
現在切換成新增的專案了。
<br><img width="70%" src="img/colab_to_cloud/VM8.jpg">
</li>

<li>
點選左上角的選單圖示，展開選單，選擇[Compute Engine]
<br><img width="70%" src="img/colab_to_cloud/VM10.jpg">
</li>

<li>
要啟用API
<br><img width="70%" src="img/colab_to_cloud/VM9.jpg">
</li>

<li>
點選[Create Instance]建立虛擬主機。
<br><img width="70%" src="img/colab_to_cloud/VM11.jpg">
</li>

<li>
設定虛擬主機的類型，例如區域、運算能力、記憶體、作業系統等等，右邊會有價格試算。<font color="red">下面幾點千萬注意。</font>
  <ul>
  <li>地區、作業系統都會影響價格，選擇完後會馬上試算，所以可以都選擇看看比較一下。</li>
  <li>建議先租用最便宜的虛擬機器，全部跑過一遍，確認沒問題之後再租用需要的機器。否則遇到問題時，上網尋求解答的時間，租用時間仍然繼續計算費用。</li>
  </ul>
例如筆者測試所租用的主機類型如下。
  <ul>
  <li>Region: us-central1 (Iowa)</li>
  <li>Series: N1</li>
  <li>Machine type: f1-micro (1 vCPU, 614 MB memory)</li>
  <li>Boot disk: Debian GNU/Linux 10 (buster)（也有一個Deep Learning on Linux，稍微貴一點點，需要的讀者可以參考）</li>
  </ul>
<br><img width="70%" src="img/colab_to_cloud/VM12.jpg">
</li>

<li>
完成後按下[Create]即可創建。
<br><img width="70%" src="img/colab_to_cloud/VM13.jpg">
</li>

<li>
回到首頁可以看到我們創建的虛擬機器，Name及Zone我們等下會用到，拿紙筆記下來。
<br><img width="70%" src="img/colab_to_cloud/VM14.jpg">
</li>


</ol>

<!---------------------------------->
<!---------------------------------->

<h2>Part B</h2>

<ol>

<li>
接著在電腦上安裝Google Cloud，這是為了要讓我們的電腦(localhost)連線到VM instance，安裝方法參考<a href="https://cloud.google.com/sdk/docs/install">這裡</a>。直接下載Cloud SDK installer並安裝。
<br><img width="70%" src="img/colab_to_cloud/local1.jpg">
</li>

<li>
安裝的最後一步，就保持預設的全部勾選就好。
<br><img width="70%" src="img/colab_to_cloud/local2.jpg">
</li>

<li>
因為剛剛安裝的最後一步有說開啟gcloud init初始化設定，所以會自動開啟命令提示字元。首先會要求登入，輸入y後按下Enter確定。<font color="red">如果有順利開啟的話直接跳到第7步。</font>
<br><img width="70%" src="img/colab_to_cloud/local3.jpg">
</li>

<li>
如果沒有開啟gcloud init或是初始化到一半被中斷，也可以從[桌面]或是[開始]的捷徑[Google Cloud SDK Shell]執行。
<br><img width="70%" src="img/colab_to_cloud/local4.jpg">
</li>

<li>
輸入<code>gcloud init</code>。
<br><img width="70%" src="img/colab_to_cloud/local5.jpg">
</li>

<li>
可以選擇繼續上次未完成的初始化或是重新設定。
<br><img width="70%" src="img/colab_to_cloud/local6.jpg">
</li>

<li>
接著會自動開啟瀏覽器，要求登入
<br><img width="70%" src="img/colab_to_cloud/local7.jpg">
</li>

<li>
允許存取
<br><img width="70%" src="img/colab_to_cloud/local8.jpg">
</li>

<li>
接著回到gcloud init，要求你選擇專案名稱，可以選擇原本就有的專案或是新建一個，我們在這裡選擇我們剛剛新建的那一個[GCtoGCPCE]，<font color="red">注意！是看清單中的專案ID並輸入編號</font>。
<br><img width="70%" src="img/colab_to_cloud/local9.jpg">
</li>

<li>
接著問你要不要設定區域，先不要設定，輸入n後按下Enter確定。
<br><img width="70%" src="img/colab_to_cloud/local10.jpg">
</li>

<li>
接著輸入
<pre>
gcloud compute ssh --zone YOUR_ZONE YOUR_INSTANCE_NAME -- -L 8888:localhost:8888
</pre>
其中的YOUR_ZONE跟YOUR_INSTANCE_NAME就是我們在Part A最後一步所記下來的Zone跟Name，例如筆者的例子就是
<pre>
gcloud compute ssh --zone "us-central1-a" "instance-1" -- -L 8888:localhost:8888
</pre>
輸入後會問你要不要繼續，當然～
<br><img width="70%" src="img/colab_to_cloud/local11.jpg">
</li>

<li>
會跳出連線的視窗，連線成功！
<br><img width="70%" src="img/colab_to_cloud/local12.jpg">
</li>

</ol>


<!---------------------------------->
<!---------------------------------->

<h2>Part C</h2>



<ol>

<li>
接下來的命令都是在這個虛擬主機上執行，<font color="red">不是在本機的命令提示字元</font>。在Windows 10，如果要把指令貼上去，不能用Ctrl+V，要按滑鼠右鍵。
</li>

<li>
先試試
<code>
python --version
</code>
及
<code>
python3 --version
</code>
看哪一個可以執行。例如筆者的情況就是
<br>執行<code>python3 --version</code>顯示<code>Python 3.7.3</code>，
<br>執行<code>python --version</code>顯示<code>-bash: python: command not found</code>，
<br>所以我必須要用<code>python3</code>
<br><img width="70%" src="img/colab_to_cloud/conn1.jpg">
</li>

<li>
先輸入
<pre>
pip
</pre>
看看有沒有安裝pip了，如果還沒有安裝pip的話，會出現
<pre>-bash: pip: command not found</pre>
的錯誤訊息，參考下一步。
</li>

<li>
（安裝pip的方法，若已有安裝可跳過）
先輸入
<pre>curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py</pre>
再來輸入
<br><code>python get-pip.py</code>或是<code>python3 get-pip.py</code>
<br>看你的版本來決定。<a href="https://pip.pypa.io/en/stable/installing/">官方的安裝說明</a>。
  <ul>
  <li>如果出現
<pre>ModuleNotFoundError: No module named 'distutils.util'</pre>
的錯誤訊息，就先執行
<pre>
sudo apt-get install python3-distutils
</pre>
這個解決方法是從參考<a href="https://askubuntu.com/questions/1239829/modulenotfounderror-no-module-named-distutils-util">這裡</a>學來的。安裝時會有一個確認訊息，輸入y後按下Enter同意。
  </li>
  <li>
另外，筆者在安裝pip的時候，出現了如下的警告訊息，
<pre>
WARNING: The scripts pip, pip3 and pip3.7 are installed in '/home/bfhaha/.local/bin' which is not on PATH.
Consider adding this directory to PATH or, if you prefer to suppress this warning, use --no-warn-script-location.
</pre>
<font color="red">注意其中的/home/bfhaha/.local/bin</font>，意思是pip安裝的位置不在預設路徑中，要將其加入，所以按照筆者的情況，就要輸入
<pre>
export PATH="$PATH:/home/bfhaha/.local/bin"
</pre>
這個解決方法是從<a href="https://stackoverflow.com/questions/61026031/pip-installation-for-python3-problem-consider-adding-this-directory-to-path">這裡</a>學來的。
  </li>
  </ul>
總結來說，筆者就是得依序<font color="red">分別</font>執行下面四個指令
<pre>
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
sudo apt-get install python3-distutils
python3 get-pip.py
export PATH="$PATH:/home/bfhaha/.local/bin"
</pre>
</li>

<li>
接下來，依序完成下面三個指令（官方說明是說要安裝Jupyter，但其實不用，如果要安裝的話參考<a href="https://jupyter.org/install">官方安裝說明</a>）
<pre>pip install jupyter_http_over_ws</pre>
<pre>jupyter serverextension enable --py jupyter_http_over_ws</pre>
<pre>
jupyter notebook \
  --NotebookApp.allow_origin='https://colab.research.google.com' \
  --port=8888 \
  --NotebookApp.port_retries=0
</pre>
最後一個指令完成時，會出現
<pre>
Or copy and paste one of these URLs:
http://localhost:8888/?token=xxxxxxxxxxxxxxxxxxxxxxxxxx
</pre>
把這個訊息複製下來。Windows 10中，將其選起來就會自動複製。
<br><img width="70%" src="img/colab_to_cloud/conn2.jpg">
</li>

<li>
在瀏覽器中貼上剛剛複製的網址，如果可以進到Jupyter Notebook就表示連線成功了。
<br><img width="70%" src="img/colab_to_cloud/conn3.jpg">
</li>

</ol>

<!---------------------------------->
<!---------------------------------->

<h2>Part D</h2>


<ol>

<li>
在Google Colab中，右上角有個[Connect]（如果已經連線，則會顯示RAM及Disk），旁邊有一個小小的向下箭頭，點下去，選取[Connect to local runtime]。
<br><img width="70%" src="img/colab_to_cloud/colab1.jpg">
</li>

<li>
在出現的畫面中，輸入剛剛複製的網址，並按下Connect連線即可。
<br><img width="70%" src="img/colab_to_cloud/colab2.jpg">
</li>

<li>
連線成功！
<br><img width="70%" src="img/colab_to_cloud/colab3.jpg">
</li>


<li>
如果連線失敗的話，在Google Colab左下角會出現Unable to connect to the runtime.的錯誤訊息。
<br><img width="70%" src="img/colab_to_cloud/colab4.jpg">
</li>

</ol>

</body>
</html>

